@page "/him/my-stuff/main"
@inherits MainPageBase<OwnedItem>
<MudPaper Class="moog-pg-banner mt-3 px-3 py-4" Elevation="1">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.h1" Color="@Color.Primary" Style="font-weight:800; font-size:20pt;">@HeaderTitle</MudText>
		<MudButton Variant="Variant.Filled" Size="Size.Small" DropShadow="false" Class="moog-btn-base" Color="Color.Primary"
				   StartIcon="material-symbols-rounded/add_circle" OnClick="@(args => PerformCRUC(CRUDCModes.CREATE))">
			Add New
		</MudButton>
    </MudStack>
</MudPaper>
<MudPaper Class="mt-3 pa-3 overflow-y-auto rounded-lg" Elevation="1" Height="calc(100vh - 165px)">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexStart" StretchItems="StretchItems.None">
        <MudTextField Clearable="true" ShrinkLabel="true" Immediate="true" Variant="Variant.Text" Class="moog-mud-form-field bordered"
                      AdornmentIcon="material-symbols-rounded/search" Adornment="Adornment.Start" AdornmentColor="Color.Primary"
                      Placeholder="Search text here..." HelperText="<Search input instruction here>"
                      @bind-Value="SearchText" OnKeyDown="OnSearchTextBoxKeyDown" @ref=UITextBoxSearch Disabled=IsSearching />
        <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Primary" DropShadow="false" Class="moog-btn-base"
				   StartIcon="material-symbols-rounded/search" OnClick="OnSearchClicked">Search</MudButton>
    </MudStack>
    <MudDataGrid Dense="true" Hover="true" FixedHeader="true" Striped="true" Loading=@IsSearching RowsPerPage="50" Elevation="0"
                 ColumnResizeMode="ResizeMode.Container" SortMode="SortMode.Multiple"
                 Class="mt-2 moog-mud-datagrid main-pg"
                 @ref="MainDataGrid" ServerData="ServerDataFunc"
                 T="OwnedItem">
        <Columns>
            <TemplateColumn Title="Asset Name" 
				HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell" 
				HeaderStyle="min-width:300px" Context="rowData">
                <CellTemplate>
                    @if (rowData.Item.ObjectState.Is(ObjectStates.WRITTEN_OFF, ObjectStates.SOLD, ObjectStates.GIFTED_OTHER))
                    {
                        <span style="text-decoration:line-through; font-style:italic; color:var(--metronic-gray-400);">@rowData.Item.ObjectName</span>
                    }
                    else if (rowData.Item.ObjectState.Is(ObjectStates.LOANED))
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <span style="font-style:italic; color:var(--material-amber-700);">@rowData.Item.ObjectName</span>
                            <MudIcon Icon="@Icons.Material.Rounded.WarningAmber" Style="color:var(--material-amber-700);" />
                        </MudStack>
                    }
                    else
                    {
                        <span style="font-weight:500;">@rowData.Item.ObjectName</span>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Category"
                            HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell"
                            HeaderStyle="min-width:200px" Context="rowData">
                <CellTemplate>
                    <span>@(rowData.Item.Category != null ? rowData.Item.Category.ObjectName : "-")</span>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Title="Brand" Property="x => x.Brand"
                            HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell"
							HeaderStyle="min-width:200px" />
            <PropertyColumn Title="Model" Property="x => x.ModelNo"
                            HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell"
                            HeaderStyle="min-width:180px" />
            <PropertyColumn Title="S/N" Property="x => x.SerialNumber" 
				HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell reddit-mono-400"
							HeaderStyle="min-width:180px" />
            <PropertyColumn Title="Price" Property="x => x.PurchasedPrice" Format="$ #,##0.00"
                            HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell" CellStyle="text-align:right" />
            <PropertyColumn Title="Purhcased Date" Property="x => x.PurchasedDate" Format="dd-MMM-yyyy"
                            HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell" 
							HeaderStyle="min-width:180px" CellStyle="text-align:center" />
            <TemplateColumn Title="Made In" Sortable="false" Filterable="false"
                            HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell"
                            HeaderStyle="min-width:180px" Context="rowData">
                <CellTemplate>
                    @if (rowData.Item.ManufacturedCountry != null && !string.IsNullOrEmpty(rowData.Item.ManufacturedCountry.FlagIconPath))
                    {
                        <MudStack Row=true AlignItems="AlignItems.Center" Justify="Justify.FlexStart" Spacing="1">
                            <MudImage Src=@(rowData.Item.ManufacturedCountry!.FlagIconPath!) Height="12" />
                            <MudText Typo="Typo.body1">@rowData.Item.ManufacturedCountry.ObjectName</MudText>
                        </MudStack>
                    }
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="State" Sortable="false" Filterable="false"
                            HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell" CellStyle="text-align:center" Context="rowData">
                <CellTemplate>
                    @* @(ObjectStates.GetDisplayText(rowData.Item.ObjectState).ToUpper()) *@
                    <MudChip Size="Size.Small" T="string" Class=@($"status-chip-tiny") Style=@_stateLightStyles[rowData.Item.ObjectState!]>
                        @(ObjectStates.GetDisplayText(rowData.Item.ObjectState).ToUpper())
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Title="Barcode" Property="x => x.Barcode"
                            HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell reddit-mono-400" />
            <PropertyColumn Title="ID" Property="x => x.ObjectCode" HeaderClass="moog-mud-datagrid-hdr main-pg" CellClass="moog-mud-datagrid-cell reddit-mono-400" />
            <TemplateColumn Title="Action" HeaderClass="moog-mud-datagrid-hdr main-pg" Sortable="false" Filterable="false" StickyRight="true"
                            CellClass="moog-mud-datagrid-cell" CellStyle="padding-inline-end:4px; padding-inline-start:4px">
                <CellTemplate>
                    <MudStack Row="true" Spacing="1">
						<MudIconButton Class="moog-ico-btn-datagrid-action" Icon="@Icons.Material.Rounded.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(args => PerformCRUC(CRUDCModes.UPDATE, context.Item.Id))" />
						<MudIconButton Class="moog-ico-btn-datagrid-action" Icon="@Icons.Material.Rounded.FileCopy" Size="Size.Small" Color="Color.Success" OnClick="@(args => PerformCRUC(CRUDCModes.CLONE, context.Item.Id))" />
						<MudIconButton Class="moog-ico-btn-datagrid-action" Icon="@Icons.Material.Rounded.Visibility" Size="Size.Small" Color="Color.Info" OnClick="@(args => PerformCRUC(CRUDCModes.READ, context.Item.Id))" />
						<MudIconButton Class="moog-ico-btn-datagrid-action" Icon="@Icons.Material.Rounded.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(args => DeleteRecord(context.Item))" />
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="OwnedItem" Class="moog-mud-datagrid-pager" PageSizeOptions="new[] { 10, 20, 30, 50, 80, 100 }" />
        </PagerContent>
    </MudDataGrid>
</MudPaper>

@code {
	#region UI VARIABLES

	Dictionary<string, string> _statesCssClasses = new() {
		{ ObjectStates.NEW, "status-chip-pink-light" },
		{ ObjectStates.BNIB, "status-chip-pink-light" },
		{ ObjectStates.IN_USE, "status-chip-green-light" },
		{ ObjectStates.LOANED, "status-chip-amber-light"},
		{ ObjectStates.UNKNOWN, "status-chip-brown-light"},
		{ ObjectStates.OTHER, "status-chip-brown-light"},
		{ ObjectStates.DRAFT, "status-chip-teal-light"},
		{ ObjectStates.GIFTED_OTHER, "status-chip-blue-gray-light"},
		{ ObjectStates.SOLD, "status-chip-blue-gray-light"},
		{ ObjectStates.WRITTEN_OFF, "status-chip-blue-gray-light"},
		{ ObjectStates.IN_STASH, "status-chip-purple-light" },
		{ ObjectStates.BROKEN, "status-chip-blue-gray-light" },
		{ ObjectStates.RARELY_USED, "status-chip-amber-light" },
	};

	Dictionary<string, string> _stateLightStyles = [];

	#endregion

	#region PAGE LIFECYCLE FUNCTIONS
	public override Task SetParametersAsync(ParameterView parameters)
	{
		UrlPrefix = "/him/my-stuff";
		SearchParamName = "myStuffSearchParam";
		_stateLightStyles = ObjectStates.GetLightStyles();
		return base.SetParametersAsync(parameters);
	}

	protected override async Task OnInitializedAsync()
	{
		await Task.CompletedTask;
	}

	#endregion

	#region UI FUNCTIONS
	async Task OnSearchClearClicked(MouseEventArgs args)
	{
		await UITextBoxSearch!.FocusAsync();
		await MainDataGrid.ReloadServerData();
	}
	#endregion

	#region UI BASE FUNCTIONS
	protected override async Task<GridData<OwnedItem>> ServerDataFunc(GridState<OwnedItem> gridState)
	{
		if (IsSearching) return new GridData<OwnedItem>
		{
			Items = [],
			TotalItems = 0
		};

		try
		{
			IsSearching = true;
			int totalItemCount = 0;
			//if (gridState.SortDefinitions.Count > 0)
			//{
			//	var firstSort = gridState.SortDefinitions.First();
			//	result = firstSort.Descending
			//		? result.OrderByDescending(firstSort.SortFunc).ToList()
			//		: result.OrderBy(firstSort.SortFunc).ToList();
			//}

			if (gridState.FilterDefinitions.Any())
			{
				//var filterFunctions = gridState.FilterDefinitions.Select(x => x.GenerateFilterFunction());
				//result = result
				//	.Where(x => filterFunctions.All(f => f(x)))
				//	.ToList();
			}
			else
			{
				var result = await Uow.OwnedItems.SearchNewAsync(PageSize, MainDataGrid.CurrentPage + 1, SearchText);
				MainDataList = result.Value;
				totalItemCount = result.Key;
			}

			//var totalNumberOfFilteredItems = result.Count;

			//result = result
			//	.Skip(gridState.StartIndex)
			//	.Take(gridState.Count)
			//	.ToList();

			return new GridData<OwnedItem>
			{
				Items = MainDataList,
				TotalItems = totalItemCount
			};
		}
		catch (Exception ex)
		{
			await JsRuntime.InvokeVoidAsync("console.error", ex.GetFullMessage());

			return new GridData<OwnedItem>
			{
				Items = [],
				TotalItems = 0
			};
		}
		finally
		{
			IsSearching = false;
		}
	}
    #endregion
}
