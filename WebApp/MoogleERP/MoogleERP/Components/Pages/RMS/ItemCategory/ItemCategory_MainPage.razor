@page "/rms/item-category/main"
@using DataLayer.AuxComponents.Extensions
@inherits MainPageBase<ItemCategory>
<MudPaper Class="moog-pg-banner mt-3 px-3 py-4" Elevation="1">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.h1" Color="@Color.Primary" Style="font-weight:800; font-size:20pt;">@HeaderTitle</MudText>
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Rounded.AddCircle" Size="Size.Small" Color="Color.Primary" OnClick="@(args => PerformCRUC(CRUDCModes.CREATE))">
            Add New
        </MudButton>
    </MudStack>
</MudPaper>
<MudPaper Class="mt-3 pa-3" Elevation="1" Height="calc(100vh - 165px)" >
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.FlexStart" StretchItems="StretchItems.None">
        <MudTextField Immediate="true" @bind-Value="SearchText" Variant="Variant.Text" AdornmentIcon="@Icons.Material.Rounded.Search" Placeholder="Search text here..."
					  Adornment="Adornment.Start" AdornmentColor="Color.Primary" Disabled=IsSearching OnKeyDown="OnSearchTextBoxKeyDown" Class="mudui-textbox" @ref=UITextBoxSearch />
        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Rounded.AddCircle" Size="Size.Small" Color="Color.Primary">Search</MudButton>
    </MudStack>
	<MudDataGrid Class="main-pg-datagrid mt-2" @ref="MainDataGrid" T="ItemCategory" ServerData="ServerDataFunc" Dense="true" Hover="true" FixedHeader="true" Striped="true" Loading=@IsSearching RowsPerPage=@PageSize
			 ColumnResizeMode="ResizeMode.Container" Height="calc(100vh - 270px)" >
		<Columns>
			<PropertyColumn Property="x => x.ObjectName" Title="Name" HeaderClass="mud-datagrid-hdr" CellClass="mud-datagrid-cell" />
			<TemplateColumn Title="Parent" HeaderClass="mud-datagrid-hdr" Sortable="false" Filterable="false" CellClass="mud-datagrid-cell" Context="rowData" >
				<CellTemplate>
					<MudText Typo="Typo.body1">@(rowData.Item.Parent != null ? rowData.Item.Parent.ObjectName : "-")</MudText>
				</CellTemplate>
			</TemplateColumn>
			<PropertyColumn Property="x => x.HierarchyPath" Title="Hierarchy Path" HeaderClass="mud-datagrid-hdr" CellClass="mud-datagrid-cell reddit-mono-400" />
			<PropertyColumn Property="x => x.ObjectCode" Title="ID" HeaderClass="mud-datagrid-hdr" CellClass="mud-datagrid-cell reddit-mono-400" />
			<TemplateColumn Title="Action" HeaderClass="mud-datagrid-hdr" Sortable="false" Filterable="false" StickyRight="true"
							CellClass="mud-datagrid-cell" CellStyle="padding-inline-end:4px; padding-inline-start:4px">
				<CellTemplate>
					<MudStack Row="true" Spacing="1">
						<MudIconButton Icon="@Icons.Material.Rounded.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(args => PerformCRUC(CRUDCModes.UPDATE, context.Item.Id))" />
						<MudIconButton Icon="@Icons.Material.Rounded.FileCopy" Size="Size.Small" Color="Color.Success" OnClick="@(args => PerformCRUC(CRUDCModes.CLONE, context.Item.Id))" />
						<MudIconButton Icon="@Icons.Material.Rounded.Visibility" Size="Size.Small" Color="Color.Info" OnClick="@(args => PerformCRUC(CRUDCModes.READ, context.Item.Id))" />
						<MudIconButton Icon="@Icons.Material.Rounded.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(args => DeleteRecord(context.Item))" />
					</MudStack>
				</CellTemplate>
			</TemplateColumn>
		</Columns>
		<PagerContent>
			<MudDataGridPager T="ItemCategory" Class="cust-datagrid-pager" />
		</PagerContent>
    </MudDataGrid>
</MudPaper>

@code {
	#region UI VARIABLES

	#endregion

	#region PAGE LIFECYCLE FUNCTIONS
	public override Task SetParametersAsync(ParameterView parameters)
	{
		UrlPrefix = "/rms/item-category";
		SearchParamName = "itemCategorySearchParam";
		return base.SetParametersAsync(parameters);
	}

	protected override async Task OnInitializedAsync()
	{
		await Task.CompletedTask;
	}
	#endregion

	#region UI FUNCTIONS
	#endregion

	#region UI BASE FUNCTIONS
	protected override async Task<GridData<ItemCategory>> ServerDataFunc(GridState<ItemCategory> gridState)
	{
		if (IsSearching) return new GridData<ItemCategory>
		{
			Items = [],
			TotalItems = 0
		};

		try
		{
			IsSearching = true;
			int totalItemCount = 0;
			//if (gridState.SortDefinitions.Count > 0)
			//{
			//	var firstSort = gridState.SortDefinitions.First();
			//	result = firstSort.Descending
			//		? result.OrderByDescending(firstSort.SortFunc).ToList()
			//		: result.OrderBy(firstSort.SortFunc).ToList();
			//}

			if (gridState.FilterDefinitions.Any())
			{
				//var filterFunctions = gridState.FilterDefinitions.Select(x => x.GenerateFilterFunction());
				//result = result
				//	.Where(x => filterFunctions.All(f => f(x)))
				//	.ToList();
			}
			else
			{
				var result = await Uow.ItemCategories.SearchNewAsync(PageSize, MainDataGrid.CurrentPage + 1, SearchText);
				MainDataList = result.Value;
				totalItemCount = result.Key;
			}

			//var totalNumberOfFilteredItems = result.Count;

			//result = result
			//	.Skip(gridState.StartIndex)
			//	.Take(gridState.Count)
			//	.ToList();

			return new GridData<ItemCategory>
			{
				Items = MainDataList,
				TotalItems = totalItemCount
			};
		}
		catch (Exception ex)
		{
			await JsRuntime.InvokeVoidAsync("console.error", ex.GetFullMessage());

			return new GridData<ItemCategory>
			{
				Items = [],
				TotalItems = 0
			};
		}
		finally
		{
			IsSearching = false;
		}
	}
    #endregion
}
