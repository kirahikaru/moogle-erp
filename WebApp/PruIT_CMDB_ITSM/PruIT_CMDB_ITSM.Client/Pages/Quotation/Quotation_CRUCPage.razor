@page "/fin/quotation/cruc/{CRUCMode}"
@page "/fin/quotation/cruc/{CRUCMode}/{id:int}"

@* @rendermode InteractiveAuto*@

@inherits CRUCPageBase<Quotation>

@if (CurrentObject != null && CurrentEditContext != null)
{
    <EditForm EditContext="CurrentEditContext" OnValidSubmit="SaveDummy" OnInvalidSubmit="SaveDummy" >
        <DataAnnotationsValidator />
        <MudPaper Class="px-4 py-3 rounded" Width="100%" Elevation="0" Square="true" Style="background-color:var(--pru-cyan-tw-50); border: solid 1px var(--pru-cyan-tw-400)">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <div style="color:var(--pru-cyan-default); font-size:28px;">
                    <span style="font-weight:800">@HeaderTitle</span>
                    @if (CRUCMode == CRUDCModes.READ)
                    {
                        <MudChip Size="Size.Small" Color="Color.Success" Class=@($"status-chip-tiny") T="string" Style="margin-top:-5px">View</MudChip>
                    }
                    else if (CRUCMode == CRUDCModes.UPDATE)
                    {
                        <MudChip Size="Size.Small" Color="Color.Info" Class=@($"status-chip-tiny") T="string">Update</MudChip>
                    }
                    else if (CRUCMode == CRUDCModes.CREATE)
                    {
                        <MudChip Size="Size.Small" Color="Color.Info" Class=@($"status-chip-tiny") T="string">New</MudChip>
                    }
                    else if (CRUCMode == CRUDCModes.CLONE)
                    {
                        <MudChip Size="Size.Small" Color="Color.Info" Class=@($"status-chip-tiny") T="string">New (Clone)</MudChip>
                    }
                </div>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd">
                    @if (!IsViewMode)
                    {
                        <MudButton Variant="Variant.Filled" Size="Size.Small" DropShadow="false" Class="pru-btn-base" Color="Color.Primary"
                                   StartIcon="material-symbols-rounded/save_as"
                                   OnClick="@(() => Save())">Save</MudButton>
                        <MudButton Variant="Variant.Filled" Size="Size.Small" DropShadow="false" Class="pru-btn-base" Color="Color.Primary"
                                   StartIcon="material-symbols-rounded/save"
                                   OnClick="@(() => Save(true))">Save & Close</MudButton>
                        <MudButton Variant="Variant.Filled" Size="Size.Small" DropShadow="false" Class="pru-btn-base" Color="Color.Secondary"
                                   StartIcon="material-symbols-rounded/cancel"
                                   OnClick="Cancel">Cancel</MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Filled" Size="Size.Small" DropShadow="false" Class="pru-btn-base" Color="Color.Default"
                                   StartIcon="material-symbols-rounded/close"
                                   OnClick="Cancel">Close</MudButton>
                    }
                </MudStack>
            </MudStack>
        </MudPaper>
        <MudTabs Class="pru-mud-tab cruc-pg mt-3" Elevation="0">
            <MudTabPanel Text="Main" Icon="material-symbols-rounded/home" Class="pru-mud-tab-panel" Style="min-width:120px">
                <MudPaper Class="px-4 pt-2 pb-5 overflow-y-auto" Height="calc(100vh - 210px)" Width="100%" Elevation="0" Style="position:relative">
                    <MudGrid Spacing="2" Justify="Justify.SpaceEvenly">
                        <MudItem xs="1">
                            <MudSelect ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" Required="true"
                                       Label="LBU" T="string"
                                       Value=CurrentObject!.LBU For="@(() => CurrentObject.LBU)" ValueChanged="OnLBUChanged" OnlyValidateIfDirty="true">
                                @foreach (string lbuID in _lbuIDList)
                                {
                                    <MudSelectItem Value=@lbuID>@lbuID</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="2">
                            <MudDatePicker ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered pru-ui-datepicker" Editable="true" DateFormat="dd-MMM-yyyy" Required="true"
                                           AdornmentIcon="material-symbols-rounded/calendar_month" AdornmentColor="@Color.Primary"
                                           Label="Date" 
                                           @bind-Date=@CurrentObject.EffectiveDate For="@(() => CurrentObject.EffectiveDate)" />
                        </MudItem>
                        <MudItem xs="3">
                            <MudTextField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered"
                                          Label="Ref #"
                                          @bind-Value=CurrentObject!.ObjectCode For="@(() => CurrentObject.ObjectCode)" OnlyValidateIfDirty="true"
                                          MaxLength="80"/>
                        </MudItem>
                        <MudItem xs="2">
                            <MudDatePicker ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered pru-ui-datepicker" Editable="true" DateFormat="dd-MMM-yyyy" Required="true"
                                           AdornmentIcon="material-symbols-rounded/calendar_month" AdornmentColor="@Color.Primary"
                                           Label="Expiry Date"
                                           @bind-Date=@CurrentObject.ExpiryDate For="@(() => CurrentObject.ExpiryDate)" />
                        </MudItem>
                        <MudItem xs="4">
                            <MudComboBox ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered pru-ui-combo-box" Editable="true" Variant="Variant.Text" SearchBox="true" Strict="true" autocomplete="new-password"
                                         Label="Vendor/Supplier" T="string"
                                         @bind-Value="@CurrentObject.VendorID" For="@(() => CurrentObject.VendorID)"
                                         ToStringFunc="@(e => string.IsNullOrEmpty(e) ? "" : _vendorList.Single<DropdownSelectItem>(x => x.Key == e)?.Value)">
                                <ChildContent>
                                    @foreach (var vendor in _vendorList)
                                    {
                                        <MudComboBoxItem T="string" Value="@vendor.Key" Text="@vendor.Value">@vendor.Value</MudComboBoxItem>
                                    }
                                </ChildContent>
                            </MudComboBox>
                            @* <MudSelect Clearable="true" ReadOnly="@IsViewMode" Dense="true" Required="true"
                                       Label="Supplier/Vendor"
                                       @bind-Value=CurrentObject!.VendorID For="@(() => CurrentObject.VendorID)" OnlyValidateIfDirty="true">
                                @foreach (DropdownSelectItem vendor in _vendorList)
                                {
                                    <MudSelectItem Value=@vendor.Key>@vendor.Value</MudSelectItem>
                                }
                            </MudSelect> *@
                        </MudItem>
                        <MudItem xs="8">
                            <MudTextField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" Required="true"
                                          Label="One-liner Summary" 
                                          @bind-Value=CurrentObject!.ObjectName For="@(() => CurrentObject.ObjectName)" OnlyValidateIfDirty="true"
                                          MaxLength="255" />
                        </MudItem>
                        <MudItem xs="2">
                            <MudTextField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" 
                                          Label="Customer No."
                                          @bind-Value=CurrentObject!.CustomerRef For="@(() => CurrentObject.CustomerRef)" OnlyValidateIfDirty="true"
                                          MaxLength="80" />
                        </MudItem>
                        <MudItem xs="2">
                            <MudSelect ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered pru-ui-select" FullWidth="true" Required="true"
                                       Label="Status"
                                       @bind-Value=CurrentObject!.WorkflowStatus For="@(() => CurrentObject.WorkflowStatus)" OnlyValidateIfDirty="true">
                                @foreach (DropdownSelectItem wfs in _wfsList)
                                {
                                    <MudSelectItem Value=@wfs.Key>@wfs.Value</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="1">
                            <MudSelect ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered pru-ui-select" FullWidth="true" Required="true"
                                       Label="Currency"
                                       @bind-Value=CurrentObject!.CurrencyCode For="@(() => CurrentObject.CurrencyCode)" OnlyValidateIfDirty="true">
                                @foreach (DropdownSelectItem curr in _currList)
                                {
                                    <MudSelectItem Value=@curr.Key>@curr.Key</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="2">
                            <MudNumericField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" HideSpinButtons="true" Culture="@CultureInfo.GetCultureInfo("en-US")" Required="true"
                                             Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Rounded.AttachMoney" AdornmentColor=@Color.Primary
                                             Label="Total Amount" Format="@(CurrentObject.CurrencyCode == PruGC.Currencies.USD ? "#,##0.00" : "#,##0")"
                                             @bind-Value=CurrentObject!.TotalAmount For="@(() => CurrentObject.TotalAmount)" OnlyValidateIfDirty="true"
                                             Step=".1M" Min="0" />
                        </MudItem>
                        <MudItem xs="2">
                            <MudNumericField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" HideSpinButtons="true" Culture="@CultureInfo.GetCultureInfo("en-US")" 
                                             Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Rounded.AttachMoney" AdornmentColor=@Color.Primary
                                             Label="Tax Amount" Format="@(CurrentObject.CurrencyCode == PruGC.Currencies.USD ? "#,##0.00" : "#,##0")"
                                             @bind-Value=CurrentObject!.TotalTaxAmount For="@(() => CurrentObject.TotalTaxAmount)" OnlyValidateIfDirty="true"
                                             Step=".1M" Min="0" />
                        </MudItem>
                        <MudItem xs="7">
                            <MudText Typo="Typo.body1" Class="reddit-mono-400">@(CurrentObject!.FileNameDisplay)</MudText>
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" MaxLines="25" Lines=4
                                          Label="Remark"
                                          @bind-Value=CurrentObject!.Remark For="@(() => CurrentObject!.Remark)" OnlyValidateIfDirty="true"
                                          MaxLength="1000" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudStack Spacing="2" Justify=Justify.FlexStart Class="mt-3">
                                @if (!IsViewMode)
                                {
                                    <MudButton Variant="Variant.Filled" Size="Size.Small" DropShadow="false" Class="pru-btn-base in-pg-action" Color="Color.Info"
                                               StartIcon="material-symbols-rounded/add" FullWidth="false"
                                               Disabled=@(_tempItemToAdd != null) OnClick="AddQuotationItem" Style="max-width:100px">
                                        Add Item
                                    </MudButton>
                                }
                                <MudDataGrid Class="pru-mud-datagrid" Dense="true" Hover="true" FixedHeader="true" Striped="true" ReadOnly=@IsViewMode Elevation="0"
                                    ColumnResizeMode="ResizeMode.Container" HorizontalScrollbar="true" EditTrigger="DataGridEditTrigger.Manual"
                                    EditDialogOptions=@(new (){ BackdropClick=false, MaxWidth=MaxWidth.Medium, FullWidth=true }) 
                                    StartedEditingItem="@StartedEditingItem" CanceledEditingItem="@CanceledEditingItem" CommittedItemChanges="@CommittedItemChanges" Style="width:100%"
                                             @ref="_qItemDataGrid" T="QuotationItem" Items="@CurrentObject!.Items">
                                    <Columns>
                                        <PropertyColumn Property="x => x.OrderNo" Title="No." Editable="false" 
                                            HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell" CellStyle="text-align:right" Sortable="false" Context="qi">
                                            <EditTemplate>
                                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Justify="Justify.FlexStart">
                                                    <MudText Typo="Typo.body1">Order # </MudText>
                                                    <MudText Typo="Typo.body1" Style="font-weight:800">@qi.Item.OrderNo</MudText>
                                                </MudStack>
                                            </EditTemplate>
                                        </PropertyColumn>
                                        <PropertyColumn Property="x => x.ObjectName" Title="Item" HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell" Context="qi">
                                            <EditTemplate>
                                                <MudTextField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" Required="true"
                                                              Label="Name" MaxLength="255"
                                                              @bind-Value=qi.Item.ObjectName For="@(() => qi.Item.ObjectName)" OnlyValidateIfDirty="true" />
                                            </EditTemplate>
                                        </PropertyColumn>
                                        <PropertyColumn Property="x => x.SKU" Title="SKU" HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell" Context="qi">
                                            <EditTemplate>
                                                <MudTextField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered"
                                                              Label="SKU"
                                                              @bind-Value=qi.Item.SKU For="@(() => qi.Item.SKU)" OnlyValidateIfDirty="true" MaxLength="255" />
                                            </EditTemplate>
                                        </PropertyColumn>
                                        <PropertyColumn Property="x => x.UnitPrice" Title="Unit Price" Format="@(CurrentObject!.CurrencyCode == PruGC.Currencies.USD ? "#,##0.00" : "#,##0")" HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell" Context="qi" CellStyle="text-align:right"
                                        Filterable="false" Sortable="false">
                                            <EditTemplate>
                                                <MudStack Row=true Spacing="3" AlignItems="AlignItems.Start" Justify="Justify.FlexStart" StretchItems="StretchItems.All">
                                                    <MudNumericField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" HideSpinButtons="true" Culture="@CultureInfo.GetCultureInfo("en-US")" Required="true"
                                                                     Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Rounded.AttachMoney" AdornmentColor=@Color.Primary
                                                                     Label="Unit Price" Format="#,##0.##" Min="0" Step=".1M"
                                                                     @bind-Value=qi.Item.UnitPrice For="@(() => qi.Item.UnitPrice)" OnlyValidateIfDirty="true" />
                                                    <MudNumericField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" HideSpinButtons="true" Culture="@CultureInfo.GetCultureInfo("en-US")" Required="true"
                                                                     Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Rounded.Numbers"
                                                                     Label="Quantity" Format="#,##0.##" Min="0" Step=".1M"
                                                                     @bind-Value=qi.Item.Quantity For="@(() => qi.Item.Quantity)" OnlyValidateIfDirty="true" />
                                                    <MudNumericField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" HideSpinButtons="true" Culture="@CultureInfo.GetCultureInfo("en-US")" Disabled="true"
                                                                     Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Rounded.AttachMoney" AdornmentColor=@Color.Primary
                                                                     Label="Total Amount" Format="#,##0.##" Min="0" Step=".1M"
                                                                     @bind-Value=qi.Item.TotalAmount For="@(() => qi.Item.TotalAmount)" OnlyValidateIfDirty="true" />

                                                </MudStack>
                                            </EditTemplate>
                                        </PropertyColumn>
                                        <PropertyColumn Property="x => x.Quantity" Title="Quantity" Format="#,##0.##"
                                                        HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell"
                                                        CellStyle="text-align:right"
                                                        Filterable="false" Sortable="false" Context="qi">
                                            <EditTemplate>

                                            </EditTemplate>
                                        </PropertyColumn>
                                        <PropertyColumn Property="x => x.StartDate" Title="Start Date" Format="dd-MMM-yyyy" Filterable="false" Sortable="false"
                                            HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell" Context="qi">
                                            <EditTemplate>
                                                <MudStack Row=true Spacing="3" AlignItems="AlignItems.Start" Justify="Justify.FlexStart" StretchItems="StretchItems.All">
                                                    <MudDatePicker ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered pru-ui-datepicker" Editable="true" DateFormat="dd-MMM-yyyy"
                                                                   AdornmentIcon="material-symbols-rounded/calendar_month" AdornmentColor="@Color.Primary"
                                                                   Label="Start Date"
                                                                   @bind-Date=@qi.Item.StartDate For="@(() => qi.Item.StartDate)" />
                                                    <MudDatePicker ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered pru-ui-datepicker" Editable="true" DateFormat="dd-MMM-yyyy"
                                                                   AdornmentIcon="material-symbols-rounded/calendar_month" AdornmentColor="@Color.Primary"
                                                                   Label="End Date"
                                                                   @bind-Date=@qi.Item.EndDate For="@(() => qi.Item.EndDate)" />
                                                </MudStack>
                                            </EditTemplate>
                                        </PropertyColumn>
                                        <PropertyColumn Property="x => x.EndDate" Title="End Date" Format="dd-MMM-yyyy" HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell"
                                                        Filterable="false" Sortable="false" Context="qi">
                                            <EditTemplate>
                                                
                                            </EditTemplate>
                                        </PropertyColumn>
                                        <PropertyColumn Property="x => x.TotalAmount" Title="Total Amount" Format="@(CurrentObject!.CurrencyCode == PruGC.Currencies.USD ? "#,##0.00" : "#,##0")"
                                                        HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell reddit-mono-400" CellStyle="text-align:right"
                                                        Filterable="false" Sortable="false" Editable="false" Context="qi" AggregateDefinition="_itemAggr"
                                                        FooterClass="reddit-mono-500" FooterStyle="text-align:right">
                                            <EditTemplate>

                                            </EditTemplate>
                                        </PropertyColumn>
                                        <PropertyColumn Property="x => x.Remark" Title="Remark" Filterable="false" Sortable="false"
                                                        HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell"
                                                        HeaderStyle=@(DataGridHdrStyle + "; width:600px; max-width:300px")
                                                        Context="qi">
                                            <EditTemplate>
                                                <MudTextField ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered" MaxLines="25" Lines=4
                                                              Label="Remark" 
                                                              @bind-Value=qi.Item.Remark For="@(() => qi.Item.Remark)" OnlyValidateIfDirty="true"
                                                              MaxLength="1000" />
                                            </EditTemplate>
                                        </PropertyColumn>
                                        <TemplateColumn Hidden=@IsViewMode Title="Action"
                                                        HeaderClass="pru-mud-datagrid-hdr cruc-pg-items" CellClass="pru-mud-datagrid-cell d-flex justify-end" Context="qi">
                                            <CellTemplate>
                                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@qi.Actions.StartEditingItemAsync" />
                                                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" OnClick="@(() => RemoveItem(qi.Item))" />
                                            </CellTemplate>
                                        </TemplateColumn>
                                    </Columns>
                                </MudDataGrid>
                            </MudStack>
                        </MudItem>
                        @if (CurrentEditContext.GetValidationMessages().Any() || InvalidMsgList.Count > 0)
                        {
                            <MudItem xs="12" Class="pt-10">
                                @foreach (string msg in CurrentEditContext.GetValidationMessages())
                                {
                                    <MudAlert Variant="Variant.Outlined" Severity="Severity.Warning" Dense="true" Icon="material-symbols-rounded/warning" Class="pru-alert-validation mt-2">@msg</MudAlert>
                                }
                                @foreach (string key in InvalidMsgList.Keys)
                                {
                                    <MudAlert Variant="Variant.Outlined" Severity="Severity.Warning" Dense="true" Icon="material-symbols-rounded/warning" Class="pru-alert-validation mt-2">@InvalidMsgList[key]</MudAlert>
                                }
                            </MudItem>
                        }
                    </MudGrid>
                    @if (Id > 0)
                    {
                    <MudStack Row="true" Class="px-2 py-1" AlignItems="AlignItems.Center" Spacing="1" Style="position:absolute; bottom:0; left:0; right:0; background-color:var(--pru-red-tw-50)">
                        <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-gray-default)">Created By</MudText>
                        <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-red-default)">@CurrentObject.CreatedUser</MudText>
                        <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-gray-default)">on</MudText>
                        <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-red-default)">@(CurrentObject.CreatedDateTime.HasValue? CurrentObject.CreatedDateTime!.Value.ToString("dd-MMM-yyyy hh:mm:ss tt") : " - ")</MudText>
                        <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-gray-default)"> | Last Modified By</MudText>
                        <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-red-default)">@CurrentObject.ModifiedUser</MudText>
                        <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-gray-default)">on</MudText>
                        <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-red-default)">@(CurrentObject.ModifiedDateTime.HasValue? CurrentObject.ModifiedDateTime!.Value.ToString("dd-MMM-yyyy hh:mm:ss tt") : " - ")</MudText>
                    </MudStack>
                    }
                </MudPaper>
            </MudTabPanel>
            <MudTabPanel Text="History" Icon="material-symbols-rounded/history" Class="pru-mud-tab-panel" Style="min-width:120px">
                <MudPaper Class="px-4 pt-2 pb-5 overflow-y-auto" Height="calc(100vh - 210px)" Width="100%" Elevation="0" Style="position:relative">
                </MudPaper>
            </MudTabPanel>
        </MudTabs>
    </EditForm>
}


@code {
    #region UI PARAM
    IEnumerable<DropdownSelectItem> _vendorList = Enumerable.Empty<DropdownSelectItem>();
    IEnumerable<DropdownSelectItem> _lbuList = Enumerable.Empty<DropdownSelectItem>();
    IEnumerable<DropdownSelectItem> _currList = Enumerable.Empty<DropdownSelectItem>();
    IEnumerable<DropdownSelectItem> _wfsList = Enumerable.Empty<DropdownSelectItem>();
    MudDataGrid<QuotationItem> _qItemDataGrid = new();
    public readonly string DataGridHdrStyle = "font-weight:700; background-color:var(--pru-gray-default); color:#FFFFFF; border-right:1px solid #FFFFFF; padding-inline-start: 10px; padding-inline-end:5px; line-height:100%; padding-top:4px; padding-bottom:4px";
    QuotationItem? _tempItemToAdd;
    IEnumerable<string> _lbuIDList = ["PCLA", "PMLI", "PLAL"];
    AggregateDefinition<QuotationItem> _itemAggr = new AggregateDefinition<QuotationItem>
    {
        Type = AggregateType.Sum,
        NumberFormat = "N2",
        DisplayFormat = "{value}"
    };
    #endregion

    #region PAGE LIFECYCLE FUNCTIONS
    public override Task SetParametersAsync(ParameterView parameters)
    {
        UrlPrefix = "/fin/quotation";

        return base.SetParametersAsync(parameters);
    }

    protected override async Task OnInitializedAsync()
    {
        switch(CRUCMode)
        {
            case CRUCModes.READ:
                {
                    CurrentObject = await Uow.Quotations.GetFullAsync(Id);
                    IsViewMode = true;
                }
                break;
            case CRUCModes.CREATE:
                {
                    CurrentObject = new();
                }
                break;
            case CRUCModes.UPDATE:
                CurrentObject = await Uow.Quotations.GetFullAsync(Id);
                break;
            case CRUCModes.CLONE:
                {
                    var tempObj = await Uow.Quotations.GetFullAsync(Id);
                    CurrentObject = tempObj.DeepClone();
                    CurrentObject!.Id = 0;
                    CurrentObject!.ObjectCode = String.Empty;
                } break;
        }

        CurrentEditContext = new EditContext(CurrentObject!);

        HeaderTitle = ObjectDisplayName;

        await PopulateUIControl();
    }
    #endregion

    #region UI FUNCTIONS
    void AddQuotationItem()
    {
        _tempItemToAdd = new()
            {
                OrderNo = CurrentObject!.Items.Count + 1
            };
        CurrentObject!.Items.Add(_tempItemToAdd);
        _qItemDataGrid.SetEditingItemAsync(_tempItemToAdd);
    }

    void RemoveItem(QuotationItem i)
    {
        int orderNoToRemove = i.OrderNo!.Value;

        if (i.Id > 0)
        {
            //#TODO# NOT YET IMPLEMENTED
        }
        else
        {
            CurrentObject!.Items.Remove(i);

            foreach (QuotationItem item in CurrentObject!.Items.Where(x => x.OrderNo > orderNoToRemove).OrderBy(x => x.OrderNo))
            {
                item.OrderNo = orderNoToRemove;
                orderNoToRemove++;
            }
        }
    }

    void StartedEditingItem(QuotationItem item)
    {

    }

    void CanceledEditingItem(QuotationItem item)
    {
        if (_tempItemToAdd != null)
        {
            CurrentObject!.Items.RemoveAt(CurrentObject!.Items.FindIndex(x => x.OrderNo == item.OrderNo));
            _tempItemToAdd = null;
        }
    }

    void CommittedItemChanges(QuotationItem item)
    {
        _tempItemToAdd = null;
        item.TotalAmount = item.UnitPrice!.Value * item.Quantity!.Value;
    }

    private async Task OnLBUChanged(string lbu)
    {
        if (!string.IsNullOrEmpty(lbu))
        {
            CurrentObject!.LBU = lbu;
            _vendorList = await Uow.Vendors.GetForDropdownListAsync(CurrentObject!.LBU, CurrentObject!.VendorID);
        }
        else
        {
            CurrentObject!.LBU = null;
            _vendorList = [];
        }
    }
    #endregion

    #region UPDATE FUNCTIONS
    protected override async Task PreSaveProcessing()
    {
        CurrentObject!.ObjectCode = CurrentObject!.ObjectCode!.ToUpper();
        await Task.CompletedTask;
    }

    protected override async Task ValidatePreSave()
    {
        InvalidMsgList.Clear();

        bool isDuplicated = await Uow.Quotations.IsDuplicateCodeAsync(CurrentObject!.Id, CurrentObject!.ObjectCode!);

        if (isDuplicated)
        {
            InvalidMsgList.Add("ObjectCode_Duplicate", $"Quotation with reference no. '{CurrentObject.ObjectCode}' is already existed.");
        }
    }

    protected override async Task<bool> SaveAndCommitProcessing()
    {
        DateTime timestamp = DateTime.Now;

        if (CurrentObject!.Id == 0)
        {
            CurrentObject!.CreatedUser = AuditTrailUser;
            CurrentObject!.CreatedDateTime = timestamp;
        }

        CurrentObject!.ModifiedUser = AuditTrailUser;
        CurrentObject!.ModifiedDateTime = timestamp;

        int objId = await Uow.Quotations.InsertOrUpdateFullAsync(CurrentObject!);
        return objId > 0;
    }
    #endregion

    #region INTERNAL FUNCTION
    async Task PopulateUIControl()
    {
        _lbuList = PruLBUs.GetForDropdown();

        if (!string.IsNullOrEmpty(CurrentObject!.LBU))
            _vendorList = await Uow.Vendors.GetForDropdownListAsync(CurrentObject!.LBU, CurrentObject!.VendorID);

        _wfsList = QuotationWFStatuses.GetForDropdownList();
        _currList = PruGC.Currencies.GetForDropdownList();
        // await Task.CompletedTask;
    }
    #endregion
}