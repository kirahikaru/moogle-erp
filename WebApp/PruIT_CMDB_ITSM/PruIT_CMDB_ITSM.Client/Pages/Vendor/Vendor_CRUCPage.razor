@page "/vendor/cruc/{CRUCMode}"
@page "/vendor/cruc/{CRUCMode}/{id:int}"
@using System.Globalization

@* @rendermode InteractiveAuto*@
@inherits CRUCPageBase<Vendor>

@if (CurrentObject != null && CurrentEditContext != null)
{
    <EditForm EditContext="CurrentEditContext" OnValidSubmit="SaveDummy" OnInvalidSubmit="SaveDummy" >
        <DataAnnotationsValidator />
        <MudPaper Class="px-4 py-3 rounded" Width="100%" Elevation="0" Square="true" Style="background-color:var(--pru-cyan-tw-50); border: solid 1px var(--pru-cyan-tw-400)">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <div style="color:var(--pru-cyan-default); font-size:28px;">
                    <span style="font-weight:800">@HeaderTitle</span>
                    @if (CRUCMode == CRUDCModes.READ)
                    {
                        <MudChip Size="Size.Small" Color="Color.Success" Class=@($"status-chip-tiny") T="string" Style="margin-top:-5px">View</MudChip>
                    }
                    else if (CRUCMode == CRUDCModes.UPDATE)
                    {
                        <MudChip Size="Size.Small" Color="Color.Info" Class=@($"status-chip-tiny") T="string">Update</MudChip>
                    }
                    else if (CRUCMode == CRUDCModes.CREATE)
                    {
                        <MudChip Size="Size.Small" Color="Color.Info" Class=@($"status-chip-tiny") T="string">New</MudChip>
                    }
                    else if (CRUCMode == CRUDCModes.CLONE)
                    {
                        <MudChip Size="Size.Small" Color="Color.Info" Class=@($"status-chip-tiny") T="string">New (Clone)</MudChip>
                    }
                </div>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.FlexEnd">
                    @if (!IsViewMode)
                    {
                        <MudButton Variant="Variant.Filled" DropShadow="false" Class="pru-btn-base" Size="Size.Small" Color="Color.Primary" StartIcon="material-symbols-rounded/save_as"
                                   OnClick="@(() => Save())">Save</MudButton>
                        <MudButton Variant="Variant.Filled" DropShadow="false" Class="pru-btn-base" Size="Size.Small" Color="Color.Primary" StartIcon="material-symbols-rounded/save"
                                   OnClick="@(() => Save(true))">Save & Close</MudButton>
                        <MudButton Variant="Variant.Filled" DropShadow="false" Class="pru-btn-base" Size="Size.Small" Color="Color.Secondary" StartIcon="material-symbols-rounded/cancel"
                                   OnClick="Cancel">Cancel</MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Filled" DropShadow="false" Class="pru-btn-base" Size="Size.Small" Color="Color.Default" StartIcon="material-symbols-rounded/close"
                                   OnClick="Cancel">Close</MudButton>
                    }
                </MudStack>
            </MudStack>
        </MudPaper>
        <MudTabs Class="pru-mud-tab cruc-pg mt-3" Elevation="0">
            <MudTabPanel Text="Main" Icon="material-symbols-rounded/home" Class="pru-mud-tab-panel" Style="min-width:120px">
                <MudPaper Class="px-4 pt-2 pb-5 overflow-y-auto" Height="calc(100vh - 210px)" Width="100%" Elevation="0" Style="position:relative">
                    <MudGrid Spacing="2" Justify="Justify.SpaceEvenly">
                        <MudItem xs="8">
                            <MudTextField ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" FullWidth="true" Class="pru-mud-form-field bordered" Required="true"
                                          Label="Name" MaxLength="255"
                                          @bind-Value=CurrentObject!.ObjectName For="@(() => CurrentObject.ObjectName)" OnlyValidateIfDirty="true"
                                          RequiredError="'Name' is required." />
                        </MudItem>
                        <MudItem xs="2">
                            <MudTextField ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" FullWidth="true" Class="pru-mud-form-field bordered" Required="true"
                                          Label="ID"
                                          @bind-Value=CurrentObject!.ObjectCode For="@(() => CurrentObject.ObjectCode)" OnlyValidateIfDirty="true"
                                          RequiredError="'ID' is required." MaxLength="80"
                                          Style="text-transform:uppercase" />
                        </MudItem>
                        <MudItem xs="2">
                            <MudSelect ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered pru-ui-select" PopoverClass="pru-ui-select-popover" Required="true"
                                       Label="LBU" T="string"
                                       Value=CurrentObject!.LBU For="@(() => CurrentObject.LBU)" ValueChanged="OnLBUChanged" OnlyValidateIfDirty="true">
                                @foreach (string lbuID in _lbuIDList)
                                {
                                    <MudSelectItem Value=@lbuID>@lbuID</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="4">
                            <MudTextField ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" FullWidth="true" Class="pru-mud-form-field bordered"
                                          Label="Contract Name"
                                          @bind-Value=CurrentObject!.ContractName For="@(() => CurrentObject!.ContractName)" OnlyValidateIfDirty="true"
                                          MaxLength="255" />
                        </MudItem>
                        <MudItem xs="8">
                            <MudTextField ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" FullWidth="true" Class="pru-mud-form-field bordered"
                                          Label="Address"
                                          @bind-Value=CurrentObject!.AddressText For="@(() => CurrentObject!.AddressText)" OnlyValidateIfDirty="true"
                                          MaxLength="255" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" FullWidth="true" Class="pru-mud-form-field bordered"
                                          Label="Contact(s)" HelperText="Use ; as delimiter"
                                          @bind-Value=CurrentObject!.Contacts For="@(() => CurrentObject!.Contacts)" OnlyValidateIfDirty="true"
                                          MaxLength="255" />
                        </MudItem>
                        <MudItem xs="3">
                            <MudTextField ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" FullWidth="true" Class="pru-mud-form-field bordered"
                                          Label="Tax Registration No."
                                          @bind-Value=CurrentObject!.TaxRegNo For="@(() => CurrentObject!.TaxRegNo)" OnlyValidateIfDirty="true"
                                          MaxLength="50" />
                        </MudItem>
                        <MudItem xs="3">
                            <MudDatePicker ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Editable="true" Class="pru-mud-form-field bordered pru-ui-datepicker" 
                                           AdornmentIcon="material-symbols-rounded/calendar_month" AdornmentColor="@Color.Primary"
                                           Label="Start Date" DateFormat="dd-MMM-yyyy"
                                           @bind-Date=@CurrentObject.StartDate For="@(() => CurrentObject.StartDate)" />
                        </MudItem>
                        <MudItem xs="3">
                            <MudDatePicker ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Editable="true" Class="pru-mud-form-field bordered pru-ui-datepicker"
                                           AdornmentIcon="material-symbols-rounded/calendar_month" AdornmentColor="@Color.Primary"
                                           Label="End Date" DateFormat="dd-MMM-yyyy"
                                           @bind-Date=@CurrentObject.EndDate For="@(() => CurrentObject.EndDate)" />
                        </MudItem>
                        <MudItem xs="3">
                            <MudSelect ReadOnly=@IsViewMode Clearable="true" ShrinkLabel="true" Class="pru-mud-form-field bordered pru-ui-select" PopoverClass="pru-ui-select-popover" FullWidth="true" Required="true"
                                       Label="Status"
                                       @bind-Value=CurrentObject!.Status For="@(() => CurrentObject!.Status)" OnlyValidateIfDirty="true">
                                @foreach (DropdownSelectItem status in _statusList)
                                {
                                    <MudSelectItem Value=@status.Key>@status.Value</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" FullWidth="true" Class="pru-mud-form-field bordered" Lines=4
                                          Label="Scope / Services" 
                                          @bind-Value=CurrentObject!.ScopeOrServices For="@(() => CurrentObject!.ScopeOrServices)" OnlyValidateIfDirty="true"
                                          MaxLines="25" MaxLength="1000" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField ReadOnly="@IsViewMode" Clearable="true" ShrinkLabel="true" FullWidth="true" Class="pru-mud-form-field bordered" Lines=4
                                          Label="Remark"
                                          @bind-Value=CurrentObject!.Remark For="@(() => CurrentObject!.Remark)" OnlyValidateIfDirty="true"
                                          MaxLines="25" MaxLength="1000" />
                        </MudItem>
                        @if (CurrentEditContext.GetValidationMessages().Any() || InvalidMsgList.Count > 0)
                        {
                            <MudItem xs="12" Class="pt-10">
                                @foreach (string msg in CurrentEditContext.GetValidationMessages())
                                {
                                    <MudAlert Variant="Variant.Outlined" Severity="Severity.Warning" Dense="true" Icon="material-symbols-rounded/warning" Class="pru-alert-validation mt-2">@msg</MudAlert>
                                }
                                @foreach (string key in InvalidMsgList.Keys)
                                {
                                    <MudAlert Variant="Variant.Outlined" Severity="Severity.Warning" Dense="true" Icon="material-symbols-rounded/warning" Class="pru-alert-validation mt-2">@InvalidMsgList[key]</MudAlert>
                                }
                            </MudItem>
                        }
                    </MudGrid>
                    @if (Id > 0)
                    {
                        <MudStack Row="true" Class="px-2 py-1" AlignItems="AlignItems.Center" Spacing="1" Style="position:absolute; bottom:0; left:0; right:0; background-color:var(--pru-red-tw-50)">
                            <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-gray-default)">Created By</MudText>
                            <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-red-default)">@CurrentObject.CreatedUser</MudText>
                            <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-gray-default)">on</MudText>
                            <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-red-default)">@(CurrentObject.CreatedDateTime.HasValue? CurrentObject.CreatedDateTime!.Value.ToString("dd-MMM-yyyy hh:mm:ss tt") : " - ")</MudText>
                            <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-gray-default)"> | Last Modified By</MudText>
                            <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-red-default)">@CurrentObject.ModifiedUser</MudText>
                            <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-gray-default)">on</MudText>
                            <MudText Typo="Typo.body1" Style="font-size:8pt; color:var(--pru-red-default)">@(CurrentObject.ModifiedDateTime.HasValue? CurrentObject.ModifiedDateTime!.Value.ToString("dd-MMM-yyyy hh:mm:ss tt") : " - ")</MudText>
                        </MudStack>
                    }
                </MudPaper>
            </MudTabPanel>
        </MudTabs>
    </EditForm>
}


@code {
    #region UI PARAM
    IEnumerable<DropdownSelectItem> _lbuList = PruLBUs.GetForDropdown();
    IEnumerable<string> _lbuIDList = ["PCLA", "PMLI", "PLAL"];
    IEnumerable<DropdownSelectItem> _statusList = VendorStatuses.GetForDropdownList();

    #endregion

    #region PAGE LIFECYCLE FUNCTIONS
    public override Task SetParametersAsync(ParameterView parameters)
    {
        UrlPrefix = "/vendor";
        
        return base.SetParametersAsync(parameters);
    }

    protected override async Task OnInitializedAsync()
    {
        switch (CRUCMode)
        {
            case CRUCModes.READ:
                {
                    CurrentObject = await Uow.Vendors.GetAsync(Id);
                    IsViewMode = true;
                }
                break;
            case CRUCModes.CREATE:
                {
                    CurrentObject = new();
                }
                break;
            case CRUCModes.UPDATE:
                CurrentObject = await Uow.Vendors.GetAsync(Id);
                break;
            case CRUCModes.CLONE:
                {
                    var tempObj = await Uow.Vendors.GetAsync(Id);
                    CurrentObject = tempObj.DeepClone();
                    CurrentObject!.Id = 0;
                    CurrentObject!.ObjectCode = String.Empty;
                }
                break;
        }

        CurrentEditContext = new EditContext(CurrentObject!);
        HeaderTitle = ObjectDisplayName;
    }
    #endregion

    #region UI FUNCTIONS
    private void OnLBUChanged(string lbu)
    {
        if (!string.IsNullOrEmpty(lbu))
        {
            CurrentObject!.LBU = lbu;
        }
        else
        {
            CurrentObject!.LBU = null;
        }
    }
    #endregion

    #region UPDATE FUNCTIONS
    protected override async Task PreSaveProcessing()
    {
        CurrentObject!.ObjectCode = CurrentObject!.ObjectCode!.ToUpper();
        await Task.CompletedTask;
    }

    protected override async Task ValidatePreSave()
    {
        InvalidMsgList.Clear();

        bool isduplicated = await Uow.Vendors.IsDuplicateCodeAsync(CurrentObject!.ObjectCode!, CurrentObject!.LBU!, CurrentObject!.Id);

        if (isduplicated)
        {
            InvalidMsgList.Add("ObjectCode_Duplicate", $"Vendor with ID='{CurrentObject.ObjectCode}' is already existed.");
        }
    }

    protected override async Task<bool> SaveAndCommitProcessing()
    {
        DateTime timestamp = DateTime.Now;

        if (CurrentObject!.Id == 0)   //create
        {
            CurrentObject!.CreatedUser = AuditTrailUser;
            CurrentObject!.ModifiedUser = AuditTrailUser;
            CurrentObject!.CreatedDateTime = timestamp;
            CurrentObject!.ModifiedDateTime = timestamp;

            int objId = await Uow.Vendors.InsertAsync(CurrentObject!);

            if (objId > 0)
            {
                CurrentObject!.Id = objId;
                return true;
            }
            else
                return false;
        }
        else    // update
        {
            CurrentObject!.ModifiedUser = AuditTrailUser;
            CurrentObject!.ModifiedDateTime = DateTime.Now;

            bool isupdated = await Uow.Vendors.UpdateAsync(CurrentObject!);
            return isupdated;
        }
    }
    #endregion
}